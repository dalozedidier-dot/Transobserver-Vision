name: Collect all reports

on:
  workflow_dispatch:
    inputs:
      workflow:
        description: "Workflow name filter (optional)"
        required: false
        default: ""
      make_zip:
        description: "Create a zip bundle"
        required: false
        type: boolean
        default: true

jobs:
  collect:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install -U pip
          python -m pip install pyyaml

      - name: Show repos file
        run: |
          set -euo pipefail
          echo "=== repos.txt (first 200 lines) ==="
          sed -n '1,200p' repos.txt || true

      - name: Collect artifacts
        env:
          # Recommandé: définir un secret GH_PAT sur le repo qui exécute ce workflow.
          # github.token est souvent insuffisant pour télécharger des artefacts cross-repo.
          GH_TOKEN: ${{ secrets.GH_PAT || github.token }}
        run: |
          set -euo pipefail
          ARGS=(--repos-file repos.txt --outdir _collected_reports)
          WF="${{ inputs.workflow }}"
          if [ -n "$WF" ]; then
            ARGS+=(--workflow "$WF")
          fi
          if [ "${{ inputs.make_zip }}" = "true" ]; then
            ARGS+=(--zip)
          fi
          python scripts/collect_all_reports.py "${ARGS[@]}"

      - name: Upload collected reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: collected_reports
          path: |
            _collected_reports/**
            all_reports_bundle_*.zip
          if-no-files-found: warn
